<app-sidebar></app-sidebar>

<section class="doctors-section" dir="rtl">
  <div class="doctors-container">
    <!-- Add Doctor Header -->
    <div class="add-doctor-header">
      <h2 class="doctors-title">إدارة الأطباء</h2>
      <button class="btn add-doctor-btn" (click)="openAddDoctorModal()" aria-label="إضافة طبيب جديد">
        <i class="fas fa-plus"></i> إضافة طبيب
      </button>
    </div>

    <!-- Messages -->
    <div class="error-message" *ngIf="errorMessage" role="alert">{{ errorMessage }}</div>
    <div class="success-message" *ngIf="successMessage" role="alert">{{ successMessage }}</div>

    <!-- Loading Indicator -->
    <div class="loading-indicator" *ngIf="loading">
      <i class="fas fa-spinner fa-spin"></i> جاري تحميل الأطباء...
    </div>

    <!-- Doctors Cards -->
    <div class="doctors-grid" *ngIf="!loading">
      <div class="doctor-card" *ngFor="let doctor of doctors; let i = index" role="article" [attr.aria-label]="'بطاقة الطبيب ' + (doctor.name || 'غير متوفر')">
        <div class="doctor-image-container">
          <img
            [src]="doctor.image || defaultImage"
            [alt]="'صورة الطبيب ' + (doctor.name || 'غير متوفر')"
            class="doctor-image"
            loading="lazy"
            (error)="handleImageError($event)"
          />
        </div>
        <div class="doctor-info">
          <h3 class="doctor-name">{{ doctor.name || 'غير متوفر' }}</h3>
          <p class="doctor-detail"><strong>المعرف:</strong> {{ doctor._id || 'غير متوفر' }}</p>
          <p class="doctor-detail"><strong>الإيميل:</strong> {{ doctor.email || 'غير متوفر' }}</p>
          <p class="doctor-detail"><strong>الهاتف:</strong> {{ doctor.phone || 'غير متوفر' }}</p>
          <p class="doctor-detail"><strong>العنوان:</strong> {{ doctor.address || 'غير متوفر' }}</p>
          <p class="doctor-detail"><strong>سنوات الخبرة:</strong> {{ doctor.yearsOfExperience || 0 }}</p>
          <p class="doctor-detail"><strong>التخصص:</strong> {{ doctor.specialization || 'غير متوفر' }}</p>
          <p class="doctor-detail"><strong>التخصصات:</strong> {{ doctor.specialties?.join(', ') || 'غير متوفر' }}</p>
          <p class="doctor-detail"><strong>أيام التوفر:</strong> {{ formatSchedules(doctor.schedules) }}</p>
          <p class="doctor-detail"><strong>الحالة:</strong> {{ doctor.status || 'غير متوفر' }}</p>
          <p class="doctor-detail"><strong>عن الطبيب:</strong> {{ doctor.about || 'غير متوفر' }}</p>
          <p class="doctor-detail"><strong>كلمات خاصة:</strong> {{ doctor.specialWords?.join(', ') || 'غير متوفر' }}</p>
        </div>
        <div class="doctor-actions">
          <button class="btn action-btn view-btn" (click)="viewDoctor(doctor._id!)" [attr.aria-label]="'عرض تفاصيل الطبيب ' + (doctor.name || 'غير متوفر')">
            <i class="fas fa-eye"></i> عرض
          </button>
          <button class="btn action-btn edit-btn" (click)="selectDoctor(doctor)" [attr.aria-label]="'تعديل الطبيب ' + (doctor.name || 'غير متوفر')">
            <i class="fas fa-edit"></i> تعديل
          </button>
          <button class="btn action-btn delete-btn" (click)="openDeleteModal(doctor._id!)" [attr.aria-label]="'حذف الطبيب ' + (doctor.name || 'غير متوفر')">
            <i class="fas fa-trash-alt"></i> حذف
          </button>
        </div>
      </div>
      <div class="no-doctors" *ngIf="doctors.length === 0">
        <i class="fas fa-inbox"></i>
        <p>لا يوجد أطباء لعرضهم.</p>
      </div>
    </div>

    <!-- Doctor Modal (Add/Edit) -->
    <div class="modal" *ngIf="showModal" role="dialog" aria-labelledby="doctorModalTitle">
      <div class="modal-content">
        <button class="close-btn" (click)="closeModal()" aria-label="إغلاق نافذة إضافة أو تعديل الطبيب">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3 class="modal-title" id="doctorModalTitle">{{ isEditing ? 'تعديل الطبيب' : 'إضافة طبيب جديد' }}</h3>
        </div>
        <form [formGroup]="doctorForm" (ngSubmit)="isEditing ? updateDoctor() : createDoctor()" role="form" aria-label="إضافة أو تعديل طبيب">
          <input type="hidden" formControlName="_id">
          <!-- Basic Information -->
          <fieldset class="form-section">
            <legend>المعلومات الأساسية</legend>
            <div class="form-group">
              <label for="name">اسم الطبيب <span class="required">*</span></label>
              <input type="text" id="name" formControlName="name" placeholder="أدخل اسم الطبيب" required aria-required="true">
              <div class="error-message" *ngIf="doctorForm.get('name')?.invalid && doctorForm.get('name')?.touched">
                {{ doctorForm.get('name')?.hasError('required') ? 'اسم الطبيب مطلوب' : 'الاسم يجب أن يكون 3 أحرف أو أكثر' }}
              </div>
            </div>
            <div class="form-group">
              <label for="email">الإيميل <span class="required">*</span></label>
              <input type="email" id="email" formControlName="email" placeholder="أدخل البريد الإلكتروني" required aria-required="true">
              <div class="error-message" *ngIf="doctorForm.get('email')?.invalid && doctorForm.get('email')?.touched">
                {{ doctorForm.get('email')?.hasError('required') ? 'الإيميل مطلوب' : 'الإيميل غير صالح' }}
              </div>
            </div>
            <div class="form-group">
              <label for="phone">الهاتف <span class="required">*</span></label>
              <input type="text" id="phone" formControlName="phone" placeholder="أدخل رقم الهاتف (مثال: +966123456789)" required aria-required="true">
              <div class="error-message" *ngIf="doctorForm.get('phone')?.invalid && doctorForm.get('phone')?.touched">
                {{ doctorForm.get('phone')?.hasError('required') ? 'رقم الهاتف مطلوب' : 'رقم الهاتف يجب أن يكون 10-15 رقماً' }}
              </div>
            </div>
            <div class="form-group">
              <label for="address">العنوان <span class="required">*</span></label>
              <input type="text" id="address" formControlName="address" placeholder="أدخل العنوان" required aria-required="true">
              <div class="error-message" *ngIf="doctorForm.get('address')?.invalid && doctorForm.get('address')?.touched">
                {{ doctorForm.get('address')?.hasError('required') ? 'العنوان مطلوب' : 'العنوان يجب أن يكون 5 أحرف أو أكثر' }}
              </div>
            </div>
            <div class="form-group">
              <label for="yearsOfExperience">سنوات الخبرة <span class="required">*</span></label>
              <input type="number" id="yearsOfExperience" formControlName="yearsOfExperience" placeholder="أدخل سنوات الخبرة" min="0" required aria-required="true">
              <div class="error-message" *ngIf="doctorForm.get('yearsOfExperience')?.invalid && doctorForm.get('yearsOfExperience')?.touched">
                {{ doctorForm.get('yearsOfExperience')?.hasError('required') ? 'سنوات الخبرة مطلوبة' : doctorForm.get('yearsOfExperience')?.hasError('min') ? 'سنوات الخبرة يجب أن تكون 0 أو أكثر' : 'يجب أن تكون قيمة صحيحة' }}
              </div>
            </div>
            <div class="form-group">
              <label for="about">عن الطبيب <span class="required">*</span></label>
              <textarea id="about" formControlName="about" placeholder="أدخل وصفاً عن الطبيب" required aria-required="true"></textarea>
              <div class="error-message" *ngIf="doctorForm.get('about')?.invalid && doctorForm.get('about')?.touched">
                {{ doctorForm.get('about')?.hasError('required') ? 'الوصف مطلوب' : 'الوصف يجب أن يكون 10 أحرف أو أكثر' }}
              </div>
            </div>
            <div class="form-group">
              <label for="specialWords">كلمات خاصة <span class="required">*</span></label>
              <input type="text" id="specialWords" formControlName="specialWords" placeholder="أدخل كلمات خاصة مفصولة بفواصل (مثال: قلب, جراحة)" (input)="onSpecialWordsChange($event)" required aria-required="true">
              <div class="error-message" *ngIf="doctorForm.get('specialWords')?.invalid && doctorForm.get('specialWords')?.touched">
                {{ doctorForm.get('specialWords')?.hasError('required') ? 'الكلمات الخاصة مطلوبة' : 'يجب إدخال كلمة واحدة على الأقل' }}
              </div>
            </div>
            <div class="form-group">
              <label for="status">الحالة</label>
              <select id="status" formControlName="status" aria-label="اختر الحالة">
                <option value="متاح">متاح</option>
                <option value="غير متاح">غير متاح</option>
              </select>
            </div>
          </fieldset>
          <!-- Specialization -->
          <fieldset class="form-section">
            <legend>التخصص</legend>
            <div class="form-group">
              <label for="specialization">نوع التخصص <span class="required">*</span></label>
              <select id="specialization" formControlName="specialization" aria-label="اختر التخصص" required aria-required="true">
                <option value="" disabled selected>اختر التخصص</option>
                <option *ngFor="let spec of specializationOptions" [value]="spec">{{ spec }}</option>
              </select>
              <div class="error-message" *ngIf="doctorForm.get('specialization')?.invalid && doctorForm.get('specialization')?.touched">
                نوع التخصص مطلوب
              </div>
            </div>
            <div class="form-group" *ngIf="doctorForm.get('specialization')?.value === 'طب تخصصي'">
              <label>التخصصات <span class="required">*</span></label>
              <div class="specialties-checkboxes">
                <label *ngFor="let specialty of specialtiesList" class="checkbox-label">
                  <input type="checkbox" [value]="specialty" [checked]="doctorForm.get('specialties')?.value.includes(specialty)" (change)="toggleSpecialty($event, specialty)">
                  {{ specialty }}
                </label>
              </div>
              <div class="error-message" *ngIf="doctorForm.get('specialties')?.invalid && doctorForm.get('specialties')?.touched">
                يجب اختيار تخصص واحد على الأقل
              </div>
            </div>
          </fieldset>
          <!-- Clinics -->
          <fieldset class="form-section">
            <legend>العيادات <span class="required">*</span></legend>
            <div class="clinics-checkboxes">
              <label *ngFor="let clinic of clinics" class="checkbox-label">
                <input type="checkbox" [value]="clinic._id" [checked]="doctorForm.get('clinics')?.value.includes(clinic._id!)" (change)="toggleDoctorClinic($event, clinic._id!)">
                {{ clinic.name }}
              </label>
            </div>
            <div class="error-message" *ngIf="doctorForm.get('clinics')?.invalid && doctorForm.get('clinics')?.touched">
              يجب اختيار عيادة واحدة على الأقل
            </div>
          </fieldset>
          <!-- Availability for General Practitioners -->
          <fieldset class="form-section" *ngIf="doctorForm.get('specialization')?.value === 'طب عام'">
            <legend>أيام التوفر <span class="required">*</span></legend>
            <div class="days-checkboxes">
              <label *ngFor="let day of days" class="checkbox-label">
                <input type="checkbox" [value]="day" [checked]="isDaySelected(day)" (change)="toggleDoctorDay($event, day)">
                {{ translateDay(day) }}
              </label>
            </div>
            <div class="error-message" *ngIf="doctorForm.get('schedules')?.invalid && doctorForm.get('schedules')?.touched">
              يجب اختيار يوم واحد على الأقل
            </div>
          </fieldset>
          <!-- Schedules for Specialists -->
          <fieldset class="form-section" *ngIf="doctorForm.get('specialization')?.value === 'طب تخصصي'">
            <legend>جدول التوفر</legend>
            <div *ngFor="let schedule of schedules.controls; let i = index" [formGroup]="schedule" class="form-group schedule-group">
              <div class="schedule-header">
                <h5>جدول {{ i + 1 }}</h5>
                <button type="button" class="btn remove-schedule-btn" (click)="removeSchedule(i)" aria-label="إزالة الجدول">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
              <div class="form-group">
                <label for="schedule-clinic-{{ i }}">العيادة</label>
                <select id="schedule-clinic-{{ i }}" formControlName="clinic" aria-label="اختر العيادة">
                  <option value="" disabled selected>اختر العيادة</option>
                  <option *ngFor="let clinic of clinics" [value]="clinic._id">{{ clinic.name }}</option>
                </select>
              </div>
              <div class="form-group">
                <label>أيام التوفر</label>
                <div class="days-checkboxes">
                  <label *ngFor="let day of days" class="checkbox-label">
                    <input type="checkbox" [value]="day" [checked]="schedule.get('days')?.value.includes(day)" (change)="toggleScheduleDay($event, i, day)">
                    {{ translateDay(day) }}
                  </label>
                </div>
              </div>
              <div class="form-group">
                <label for="startTime-{{ i }}">وقت البداية</label>
                <input type="time" id="startTime-{{ i }}" formControlName="startTime">
              </div>
              <div class="form-group">
                <label for="endTime-{{ i }}">وقت النهاية</label>
                <input type="time" id="endTime-{{ i }}" formControlName="endTime">
              </div>
            </div>
            <button type="button" class="btn add-schedule-btn" (click)="addSchedule()" aria-label="إضافة جدول جديد">
              إضافة جدول
            </button>
          </fieldset>
          <!-- Image -->
          <fieldset class="form-section">
            <legend>صورة الطبيب</legend>
            <div class="form-group">
              <label for="image">تحميل صورة</label>
              <input type="file" id="image" accept="image/jpeg,image/png,image/gif" (change)="onImageSelected($event)" aria-label="تحميل صورة الطبيب">
              <div class="image-preview" *ngIf="imagePreview">
                <div class="image-container">
                  <img [src]="imagePreview" alt="معاينة صورة الطبيب" class="preview-image" loading="lazy" (error)="handleImageError($event)">
                  <p *ngIf="!imagePreview">المتصفح لا يدعم معاينة الصورة.</p>
                </div>
              </div>
              <div class="error-message" *ngIf="doctorForm.get('image')?.invalid && doctorForm.get('image')?.touched">
                الصورة غير صالحة
              </div>
            </div>
          </fieldset>
          <!-- Form Actions -->
          <div class="modal-actions">
            <button type="submit" class="btn modal-btn save-btn" [disabled]="!doctorForm.valid" [attr.aria-label]="isEditing ? 'تحديث الطبيب' : 'إنشاء الطبيب'">
              {{ isEditing ? 'تحديث' : 'إنشاء' }}
            </button>
            <button type="button" class="btn modal-btn cancel-btn" (click)="closeModal()" aria-label="إلغاء">
              إلغاء
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- View Doctor Modal (Semi-Full Screen) -->
    <div class="modal view-modal" *ngIf="showViewModal" role="dialog" aria-labelledby="viewModalTitle">
      <div class="modal-content">
        <button class="close-btn" (click)="closeViewModal()" aria-label="إغلاق نافذة عرض تفاصيل الطبيب">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3 class="modal-title" id="viewModalTitle">تفاصيل الطبيب: {{ selectedDoctor?.name || 'غير متوفر' }}</h3>
        </div>
        <div class="modal-body" *ngIf="selectedDoctor">
          <div class="detail-section">
            <h4>المعلومات الأساسية</h4>
            <div class="detail-row">
              <div class="detail-item">
                <p><strong>المعرف:</strong> {{ selectedDoctor._id || 'غير متوفر' }}</p>
              </div>
              <div class="detail-item">
                <p><strong>الاسم:</strong> {{ selectedDoctor.name || 'غير متوفر' }}</p>
              </div>
            </div>
            <div class="detail-row">
              <div class="detail-item">
                <p><strong>الإيميل:</strong> {{ selectedDoctor.email || 'غير متوفر' }}</p>
              </div>
              <div class="detail-item">
                <p><strong>الهاتف:</strong> {{ selectedDoctor.phone || 'غير متوفر' }}</p>
              </div>
            </div>
            <div class="detail-row">
              <div class="detail-item">
                <p><strong>العنوان:</strong> {{ selectedDoctor.address || 'غير متوفر' }}</p>
              </div>
              <div class="detail-item">
                <p><strong>سنوات الخبرة:</strong> {{ selectedDoctor.yearsOfExperience || 0 }}</p>
              </div>
            </div>
            <div class="detail-row">
              <div class="detail-item">
                <p><strong>الحالة:</strong> {{ selectedDoctor.status || 'غير متوفر' }}</p>
              </div>
              <div class="detail-item">
                <p><strong>عن الطبيب:</strong> {{ selectedDoctor.about || 'غير متوفر' }}</p>
              </div>
            </div>
            <p><strong>كلمات خاصة:</strong> {{ selectedDoctor.specialWords?.join(', ') || 'غير متوفر' }}</p>
          </div>
          <div class="detail-section">
            <h4>التخصص</h4>
            <div class="detail-row">
              <div class="detail-item">
                <p><strong>نوع التخصص:</strong> {{ selectedDoctor.specialization || 'غير متوفر' }}</p>
              </div>
              <div class="detail-item" *ngIf="selectedDoctor.specialties && selectedDoctor.specialties.length > 0">
                <p><strong>التخصصات:</strong> {{ selectedDoctor.specialties.join(', ') }}</p>
              </div>
            </div>
          </div>
          <div class="detail-section">
            <h4>العيادات</h4>
            <ul class="clinics-list">
              <li *ngFor="let clinicId of getNormalizedClinics(selectedDoctor?.clinics)">
                {{ getClinicName(clinicId) || 'عيادة غير معروفة' }}
              </li>
              <li *ngIf="!getNormalizedClinics(selectedDoctor?.clinics).length">غير متوفر</li>
            </ul>
          </div>
          <div class="detail-section">
            <h4>جدول التوفر</h4>
            <ul class="schedules-list">
              <li *ngFor="let schedule of selectedDoctor.schedules">
                {{ formatSchedules([schedule]) }}
              </li>
              <li *ngIf="!selectedDoctor.schedules?.length">غير متوفر</li>
            </ul>
          </div>
          <div class="detail-section" *ngIf="selectedDoctor.image">
            <h4>صورة الطبيب</h4>
            <div class="image-container">
              <img
                [src]="selectedDoctor.image || defaultImage"
                [alt]="'صورة الطبيب ' + (selectedDoctor.name || 'غير متوفر')"
                class="doctor-image"
                loading="lazy"
                (error)="handleImageError($event)"
              />
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn modal-btn cancel-btn" (click)="closeViewModal()" aria-label="إغلاق">
            إغلاق
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" *ngIf="showDeleteModal" role="dialog" aria-labelledby="deleteModalTitle">
      <div class="modal-content">
        <button class="close-btn" (click)="closeDeleteModal()" aria-label="إغلاق نافذة التأكيد">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3 class="modal-title" id="deleteModalTitle">تأكيد الحذف</h3>
        </div>
        <div class="modal-body">
          <p>هل أنت متأكد من حذف هذا الطبيب؟ لا يمكن التراجع عن هذا الإجراء.</p>
        </div>
        <div class="modal-actions">
          <button class="btn modal-btn delete-btn" (click)="confirmDelete()" aria-label="تأكيد الحذف">
            حذف
          </button>
          <button class="btn modal-btn cancel-btn" (click)="closeDeleteModal()" aria-label="إلغاء">
            إلغاء
          </button>
        </div>
      </div>
    </div>
  </div>
</section>
