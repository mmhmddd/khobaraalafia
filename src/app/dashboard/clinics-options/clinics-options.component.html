<app-sidebar></app-sidebar>

<section class="clinics-section" dir="rtl">
  <div class="clinics-container">
    <!-- Add Clinic Header -->
    <div class="add-clinic-header">
      <h2 class="clinics-title">إدارة العيادات</h2>
      <button class="btn add-clinic-btn" (click)="openAddClinicModal()" aria-label="إضافة عيادة جديدة">
        <i class="fas fa-plus"></i> إضافة عيادة
      </button>
    </div>

    <!-- Messages -->
    <div class="error-message" *ngIf="errorMessage" role="alert">{{ errorMessage }}</div>
    <div class="success-message" *ngIf="successMessage" role="alert">{{ successMessage }}</div>
    <div class="error-message" *ngIf="clinicForm.invalid && clinicForm.touched && !errorMessage">
      يرجى التحقق من جميع الحقول المطلوبة، بما في ذلك الكلمات الخاصة والفيديوهات
    </div>

    <!-- Loading Indicator -->
    <div class="loading-indicator" *ngIf="loading">
      <i class="fas fa-spinner fa-spin"></i> جاري تحميل العيادات...
    </div>

    <!-- Clinics Grid -->
    <div class="clinics-grid" *ngIf="!loading && clinics.length > 0; else noClinics">
      <div class="clinic-card" *ngFor="let clinic of clinics; trackBy: trackById">
        <div class="card-header">
          <h3 class="card-title">{{ clinic.name || 'غير متوفر' }}</h3>
          <span class="status-badge" [ngClass]="{'active': clinic.status === 'active', 'inactive': clinic.status === 'inactive'}">
            {{ clinic.status === 'active' ? 'نشط' : 'غير نشط' }}
          </span>
        </div>
        <div class="card-body">
          <p><strong>الإيميل:</strong> {{ clinic.email || 'غير متوفر' }}</p>
          <p><strong>الهاتف:</strong> {{ clinic.phone || 'غير متوفر' }}</p>
          <p><strong>نوع التخصص:</strong> {{ clinic.specializationType === 'general' ? 'طب عام' : 'طب تخصصي' }}</p>
          <p *ngIf="clinic.specialties?.length"><strong>التخصصات:</strong> {{ clinic.specialties.join(', ') }}</p>
          <p><strong>سعر الحجز:</strong> {{ clinic.price || 'غير متوفر' }}</p>
        </div>
        <div class="card-actions">
          <button class="btn action-btn view-btn" (click)="viewClinic(clinic._id!)" [attr.aria-label]="'عرض تفاصيل العيادة ' + (clinic.name || 'غير متوفر')">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn action-btn edit-btn" (click)="selectClinic(clinic)" [attr.aria-label]="'تعديل العيادة ' + (clinic.name || 'غير متوفر')">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn action-btn add-doctors-btn" (click)="openAddDoctorsModal(clinic._id!)" [attr.aria-label]="'إضافة أطباء إلى العيادة ' + (clinic.name || 'غير متوفر')">
            <i class="fas fa-user-md"></i>
          </button>
          <button class="btn action-btn delete-btn" (click)="openDeleteModal(clinic._id!)" [attr.aria-label]="'حذف العيادة ' + (clinic.name || 'غير متوفر')">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>
      </div>
    </div>
    <ng-template #noClinics>
      <div class="no-clinics">
        <i class="fas fa-inbox"></i>
        <p>لا يوجد عيادات لعرضها.</p>
      </div>
    </ng-template>

    <!-- Clinic Modal (Add/Edit) -->
    <div class="modal" *ngIf="showModal" role="dialog" aria-labelledby="clinicModalTitle">
      <div class="modal-content">
        <button class="close-btn" (click)="closeModal()" aria-label="إغلاق نافذة إضافة أو تعديل العيادة">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3 class="modal-title" id="clinicModalTitle">{{ isEditing ? 'تعديل العيادة' : 'إضافة عيادة جديدة' }}</h3>
        </div>
        <form [formGroup]="clinicForm" (ngSubmit)="isEditing ? updateClinic() : createClinic()" role="form" aria-label="إضافة أو تعديل عيادة">
          <input type="hidden" formControlName="_id">
          <!-- Basic Information -->
          <fieldset class="form-section">
            <legend>المعلومات الأساسية</legend>
            <div class="form-group">
              <label for="name">اسم العيادة <span class="required">*</span></label>
              <input type="text" id="name" formControlName="name" placeholder="أدخل اسم العيادة" required aria-required="true">
              <div class="error-message" *ngIf="clinicForm.get('name')?.invalid && clinicForm.get('name')?.touched">
                {{ clinicForm.get('name')?.hasError('required') ? 'اسم العيادة مطلوب' : 'الاسم يجب أن يكون 3 أحرف أو أكثر' }}
              </div>
            </div>
            <div class="form-group">
              <label for="email">الإيميل</label>
              <input type="email" id="email" formControlName="email" placeholder="أدخل البريد الإلكتروني" aria-required="false">
              <div class="error-message" *ngIf="clinicForm.get('email')?.invalid && clinicForm.get('email')?.touched">
                الإيميل غير صالح
              </div>
            </div>
            <div class="form-group">
              <label for="phone">الهاتف <span class="required">*</span></label>
              <input type="text" id="phone" formControlName="phone" placeholder="أدخل رقم الهاتف (مثال: +966123456789)" required aria-required="true">
              <div class="error-message" *ngIf="clinicForm.get('phone')?.invalid && clinicForm.get('phone')?.touched">
                {{ clinicForm.get('phone')?.hasError('required') ? 'رقم الهاتف مطلوب' : 'رقم الهاتف يجب أن يكون 10-15 رقماً' }}
              </div>
            </div>
            <div class="form-group">
              <label for="address">العنوان</label>
              <input type="text" id="address" formControlName="address" placeholder="أدخل العنوان" aria-required="false">
            </div>
            <div class="form-group">
              <label for="price">سعر الحجز</label>
              <input type="number" id="price" formControlName="price" placeholder="أدخل سعر الحجز" aria-required="false">
            </div>
            <div class="form-group">
              <label for="about">عن العيادة <span class="required">*</span></label>
              <textarea id="about" formControlName="about" placeholder="أدخل وصفاً عن العيادة" required aria-required="true"></textarea>
              <div class="error-message" *ngIf="clinicForm.get('about')?.invalid && clinicForm.get('about')?.touched">
                {{ clinicForm.get('about')?.hasError('required') ? 'الوصف مطلوب' : 'الوصف يجب أن يكون 10 أحرف أو أكثر' }}
              </div>
            </div>
            <div class="form-group">
              <label for="specialWords">كلمات خاصة</label>
              <div formArrayName="specialWords" class="special-words-container">
                <div *ngFor="let wordControl of specialWordsControls.controls; let i = index" [formGroupName]="i" class="special-word-item">
                  <input type="text" formControlName="word" placeholder="أدخل كلمة خاصة" aria-label="كلمة خاصة">
                  <button type="button" class="btn action-btn remove-btn" (click)="removeSpecialWord(i)" aria-label="إزالة الكلمة الخاصة" [disabled]="specialWordsControls.length === 1 && !wordControl.get('word')?.value">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                  <div class="error-message" *ngIf="wordControl.get('word')?.invalid && wordControl.get('word')?.touched">
                    الكلمة الخاصة يجب أن تكون حرفًا واحدًا على الأقل إذا تم إدخالها
                  </div>
                </div>
                <button type="button" class="btn action-btn add-word-btn" (click)="addSpecialWord()" aria-label="إضافة كلمة خاصة جديدة">
                  <i class="fas fa-plus"></i> إضافة كلمة
                </button>
              </div>
              <div class="error-message" *ngIf="clinicForm.get('specialWords')?.invalid && clinicForm.get('specialWords')?.touched">
                يرجى التأكد من أن جميع الكلمات الخاصة صالحة أو إزالة الحقول الفارغة
              </div>
            </div>
            <div class="form-group">
              <label for="videos">مقاطع الفيديو</label>
              <div formArrayName="videos" class="videos-container">
                <div *ngFor="let videoControl of videosControls.controls; let i = index" [formGroupName]="i" class="video-item">
                  <input type="file" [id]="'video-' + i" accept="video/mp4,video/avi,video/mov" (change)="onVideoFileChange($event, i)" aria-label="تحميل فيديو">
                  <input type="text" formControlName="label" placeholder="أدخل تسمية الفيديو (مثال: مقدمة العيادة)" aria-label="تسمية الفيديو">
                  <p *ngIf="videoControl.get('fileName')?.value" class="file-name">الملف: {{ videoControl.get('fileName')?.value }}</p>
                  <video *ngIf="videoControl.get('url')?.value" controls [src]="videoControl.get('url')?.value" preload="metadata" width="100%" height="auto" [attr.aria-label]="'معاينة الفيديو ' + (videoControl.get('label')?.value || (i + 1))">
                    <p>المتصفح لا يدعم تشغيل الفيديو.</p>
                  </video>
                  <button type="button" class="btn action-btn remove-btn" (click)="removeVideo(i)" aria-label="إزالة الفيديو" [disabled]="videosControls.length === 1 && !videoControl.get('file')?.value && !videoControl.get('url')?.value && !videoControl.get('label')?.value">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                  <div class="error-message" *ngIf="videoControl.get('label')?.invalid && videoControl.get('label')?.touched && videoControl.get('file')?.value">
                    تسمية الفيديو مطلوبة عند تحميل ملف فيديو
                  </div>
                </div>
                <button type="button" class="btn action-btn add-video-btn" (click)="addVideo()" aria-label="إضافة فيديو جديد">
                  <i class="fas fa-plus"></i> إضافة فيديو
                </button>
              </div>
              <p class="note">ملاحظة: يجب إدخال تسمية لكل فيديو يتم تحميله.</p>
            </div>
            <div class="form-group">
              <label for="status">الحالة</label>
              <select id="status" formControlName="status" aria-label="اختر الحالة">
                <option value="active">نشط</option>
                <option value="inactive">غير نشط</option>
              </select>
            </div>
          </fieldset>
          <!-- Specialization -->
          <fieldset class="form-section">
            <legend>التخصص</legend>
            <div class="form-group">
              <label for="specializationType">نوع التخصص <span class="required">*</span></label>
              <select id="specializationType" formControlName="specializationType" aria-label="اختر نوع التخصص" required aria-required="true">
                <option value="" disabled>اختر نوع التخصص</option>
                <option value="general">طب عام</option>
                <option value="specialized">طب تخصصي</option>
              </select>
              <div class="error-message" *ngIf="clinicForm.get('specializationType')?.invalid && clinicForm.get('specializationType')?.touched">
                نوع التخصص مطلوب
              </div>
            </div>
            <div class="form-group" *ngIf="clinicForm.get('specializationType')?.value === 'specialized'">
              <label>التخصصات <span class="required">*</span></label>
              <div class="specialties-checkboxes">
                <label *ngFor="let specialty of specialtiesList" class="checkbox-label">
                  <input type="checkbox" [value]="specialty" [checked]="clinicForm.get('specialties')?.value.includes(specialty)" (change)="toggleSpecialty($event, specialty)">
                  {{ specialty }}
                </label>
              </div>
              <div class="error-message" *ngIf="clinicForm.get('specialties')?.invalid && clinicForm.get('specialties')?.touched">
                يجب اختيار تخصص واحد على الأقل
              </div>
            </div>
          </fieldset>
          <!-- Doctors -->
          <fieldset class="form-section">
            <legend>الأطباء</legend>
            <div class="form-group">
              <label>اختر الأطباء</label>
              <div class="doctors-checkboxes">
                <label *ngFor="let doctor of doctors" class="checkbox-label">
                  <input type="checkbox" [value]="doctor._id" [checked]="clinicForm.get('doctorIds')?.value.includes(doctor._id!)" (change)="toggleDoctor($event, doctor._id!)">
                  {{ doctor.name }} ({{ doctor.specialization }}: {{ doctor.specialties?.join(', ') || 'غير متوفر' }})
                </label>
              </div>
            </div>
          </fieldset>
          <!-- Availability -->
          <fieldset class="form-section">
            <legend>أيام التوفر <span class="required">*</span></legend>
            <div class="days-checkboxes">
              <label *ngFor="let day of days" class="checkbox-label">
                <input type="checkbox" [value]="day" [checked]="clinicForm.get('availableDays')?.value.includes(day)" (change)="toggleDay($event, day)">
                {{ translateDay(day) }}
              </label>
            </div>
            <div class="error-message" *ngIf="clinicForm.get('availableDays')?.invalid && clinicForm.get('availableDays')?.touched">
              يجب اختيار يوم واحد على الأقل
            </div>
          </fieldset>
          <!-- Form Actions -->
          <div class="modal-actions">
            <button type="submit" class="btn modal-btn save-btn" [disabled]="!clinicForm.valid || isSubmitting" [attr.aria-label]="isEditing ? 'تحديث العيادة' : 'إنشاء العيادة'">
              {{ isEditing ? 'تحديث' : 'إنشاء' }}
            </button>
            <button type="button" class="btn modal-btn cancel-btn" (click)="closeModal()" aria-label="إلغاء">
              إلغاء
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- View Clinic Modal (Full Screen) -->
    <div class="modal full-screen" *ngIf="showViewModal" role="dialog" aria-labelledby="viewModalTitle">
      <div class="modal-content">
        <button class="close-btn" (click)="closeViewModal()" aria-label="إغلاق نافذة عرض تفاصيل العيادة">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3 class="modal-title" id="viewModalTitle">تفاصيل العيادة: {{ selectedClinic?.name || 'غير متوفر' }}</h3>
        </div>
        <div class="modal-body" *ngIf="selectedClinic">
          <div class="detail-section">
            <h4>المعلومات الأساسية</h4>
            <p><strong>المعرف:</strong> {{ selectedClinic._id || 'غير متوفر' }}</p>
            <p><strong>الاسم:</strong> {{ selectedClinic.name || 'غير متوفر' }}</p>
            <p><strong>الإيميل:</strong> {{ selectedClinic.email || 'غير متوفر' }}</p>
            <p><strong>الهاتف:</strong> {{ selectedClinic.phone || 'غير متوفر' }}</p>
            <p><strong>العنوان:</strong> {{ selectedClinic.address || 'غير متوفر' }}</p>
            <p><strong>سعر الحجز:</strong> {{ selectedClinic.price || 'غير متوفر' }}</p>
            <p><strong>عن العيادة:</strong> {{ selectedClinic.about || 'غير متوفر' }}</p>
            <p *ngIf="selectedClinic.specialWords?.length"><strong>كلمات خاصة:</strong> {{ selectedClinic.specialWords.join(', ') }}</p>
            <p><strong>الحالة:</strong> {{ selectedClinic.status === 'active' ? 'نشط' : 'غير نشط' }}</p>
          </div>
          <div class="detail-section">
            <h4>التخصص</h4>
            <p><strong>نوع التخصص:</strong> {{ selectedClinic.specializationType === 'general' ? 'طب عام' : 'طب تخصصي' }}</p>
            <p *ngIf="selectedClinic.specialties?.length"><strong>التخصصات:</strong> {{ selectedClinic.specialties.join(', ') }}</p>
          </div>
          <div class="detail-section">
            <h4>أيام التوفر</h4>
            <ul class="days-list">
              <li *ngFor="let day of selectedClinic.availableDays">{{ translateDay(day) }}</li>
            </ul>
            <p *ngIf="!selectedClinic.availableDays?.length">غير متوفر</p>
          </div>
          <div class="detail-section" *ngIf="selectedClinic.videos?.length; else noVideos">
            <h4>مقاطع الفيديو</h4>
            <div class="videos-grid">
              <div class="video-item" *ngFor="let video of selectedClinic.videos; let vidIndex = index">
                <p class="video-label">{{ video.label || 'فيديو بدون تسمية' }}</p>
                <video controls [src]="video.path" preload="metadata" width="100%" height="auto" [attr.aria-label]="'معاينة الفيديو ' + (video.label || (vidIndex + 1))">
                  <p>المتصفح لا يدعم تشغيل الفيديو.</p>
                </video>
                <div class="video-actions">
                  <button class="btn action-btn download-btn" (click)="downloadVideo(video.path, selectedClinic.name + '_video_' + (video.label || (vidIndex + 1)) + '.' + video.path.split('.').pop())" [attr.aria-label]="'تحميل الفيديو ' + (video.label || (vidIndex + 1))">
                    تحميل
                  </button>
                  <button class="btn action-btn delete-btn" (click)="deleteVideo(selectedClinic._id!, video._id)" [attr.aria-label]="'حذف الفيديو ' + (video.label || (vidIndex + 1))">
                    حذف
                  </button>
                </div>
              </div>
            </div>
          </div>
          <ng-template #noVideos>
            <div class="detail-section">
              <h4>مقاطع الفيديو</h4>
              <p class="no-videos">لا توجد مقاطع فيديو متاحة.</p>
            </div>
          </ng-template>
          <div class="detail-section" *ngIf="selectedClinic.doctors?.length">
            <h4>الأطباء</h4>
            <ul class="doctors-list">
              <li *ngFor="let doctor of selectedClinic.doctors">
                <strong>{{ doctor.name }}</strong> - {{ doctor.email }} ({{ doctor.specialization }}: {{ doctor.specialties?.join(', ') || 'غير متوفر' }}) - {{ doctor.status }}
              </li>
            </ul>
          </div>
          <div class="detail-section">
            <button class="btn action-btn add-doctors-btn" (click)="openAddDoctorsModal(selectedClinic._id!)" aria-label="إضافة أطباء إلى العيادة">
              <i class="fas fa-user-md"></i> إضافة أطباء
            </button>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn modal-btn cancel-btn" (click)="closeViewModal()" aria-label="إغلاق">
            إغلاق
          </button>
        </div>
      </div>
    </div>

    <!-- Add Doctors Modal -->
    <div class="modal" *ngIf="showAddDoctorsModal" role="dialog" aria-labelledby="addDoctorsModalTitle">
      <div class="modal-content">
        <button class="close-btn" (click)="closeAddDoctorsModal()" aria-label="إغلاق نافذة إضافة الأطباء">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3 class="modal-title" id="addDoctorsModalTitle">إضافة أطباء إلى العيادة</h3>
        </div>
        <form [formGroup]="addDoctorsForm" (ngSubmit)="addDoctors()" role="form" aria-label="إضافة أطباء إلى العيادة">
          <div class="form-group">
            <label for="doctors">اختر الأطباء <span class="required">*</span></label>
            <div class="doctors-checkboxes">
              <label *ngFor="let doctor of doctors" class="checkbox-label">
                <input type="checkbox" [value]="doctor._id" [checked]="selectedDoctorIds.includes(doctor._id!)" (change)="toggleDoctorInAddModal($event, doctor._id!)">
                {{ doctor.name }} ({{ doctor.specialization }}: {{ doctor.specialties?.join(', ') || 'غير متوفر' }})
              </label>
            </div>
            <div class="error-message" *ngIf="addDoctorsForm.get('doctorIds')?.invalid && addDoctorsForm.get('doctorIds')?.touched">
              يجب اختيار طبيب واحد على الأقل
            </div>
          </div>
          <div class="modal-actions">
            <button type="submit" class="btn modal-btn save-btn" [disabled]="!addDoctorsForm.valid || isSubmitting" aria-label="إضافة الأطباء">
              إضافة
            </button>
            <button type="button" class="btn modal-btn cancel-btn" (click)="closeAddDoctorsModal()" aria-label="إلغاء">
              إلغاء
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" *ngIf="showDeleteModal" role="dialog" aria-labelledby="deleteModalTitle">
      <div class="modal-content">
        <button class="close-btn" (click)="closeDeleteModal()" aria-label="إغلاق نافذة التأكيد">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3 class="modal-title" id="deleteModalTitle">تأكيد الحذف</h3>
        </div>
        <div class="modal-body">
          <p>هل أنت متأكد من حذف هذه العيادة؟ لا يمكن التراجع عن هذا الإجراء.</p>
        </div>
        <div class="modal-actions">
          <button class="btn modal-btn delete-btn" (click)="confirmDelete()" aria-label="تأكيد الحذف">
            حذف
          </button>
          <button class="btn modal-btn cancel-btn" (click)="closeDeleteModal()" aria-label="إلغاء">
            إلغاء
          </button>
        </div>
      </div>
    </div>
  </div>
</section>
